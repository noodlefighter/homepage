date: 2021-03-15
tags: 

- 树莓派
- 虚拟技术
- 持续集成

---

做树莓派应用时，头疼的是实机上缓慢的编译速度，持续集成时会希望有台性能超强的树莓派。

官方提供了一个这样的docker镜象https://hub.docker.com/r/raspbian/stretch，利用Linux的binfmt机制引用QEMU执行ARM，可以让x86计算机能直接用上raspbian环境，这篇文章记录了一次gitlab-ci runner的搭建过程。

<!-- more -->

## 主机环境布置

Debian系:

```
$ sudo apt install qemu qemu-user-static
```

Arch系：

```
$ sudo pacman -S qemu qemu-user-static binfmt-qemu-static
```

## Docker环境搭建

先简单测试一下这个官方的镜象：

```
$ docker run -itd raspbian/stretch
$ docker container ls
CONTAINER ID   IMAGE              COMMAND                  CREATED          STATUS          PORTS     NAMES
ef20fb2bc508   raspbian/stretch   "/bin/sh -c 'tail -f…"   41 seconds ago   Up 40 seconds             rasp
$ docker exec -it rasp /bin/bash
root@ef20fb2bc508:/#
root@ef20fb2bc508:/# cat /etc/os-release
PRETTY_NAME="Raspbian GNU/Linux 9 (stretch)"
NAME="Raspbian GNU/Linux"
VERSION_ID="9"
VERSION="9 (stretch)"
ID=raspbian
ID_LIKE=debian
HOME_URL="http://www.raspbian.org/"
SUPPORT_URL="http://www.raspbian.org/RaspbianForums"
BUG_REPORT_URL="http://www.raspbian.org/RaspbianBugs"
root@ef20fb2bc508:/#
```

货真价实的rasbian环境，接下来正式开搞，做一个我们自己的docker镜象，换上交大的源，把常用的工具装进来，新建`Dockerfile`：

```
FROM raspbian/stretch:041518
ENV TZ Asia/Shanghai
RUN echo "deb http://mirrors.sjtug.sjtu.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi firmware" > /etc/apt/sources.list \
    && echo "deb-src http://mirrors.sjtug.sjtu.edu.cn/raspbian/raspbian/ stretch main contrib non-free rpi firmware" >> /etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y vim build-essential wget python2.7 python3 unzip rsync bc cpio libz1 libncurses5 libstdc++6 \
                          texinfo zlib1g-dev liblzo2-dev uuid-dev pkg-config libncurses-dev \
                          asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch zlib1g-dev \
                          libgcc1 libc6-dev subversion flex uglifyjs git-core p7zip p7zip-full \
                          msmtp libssl-dev  libglib2.0-dev xmlto upx libelf-dev autoconf automake \
                          libtool autopoint device-tree-compiler gperf swig \
                          git scons \
    && apt-get clean \
    && ln -sf bash /bin/sh
```


构建`docker build . -t sk-rasbian`，等了少说30分钟才构建好。

> 发现安装java的VM也就是openjdk(jre)会失败...


## Gitlab CI测试

接下来将docker runner注册到gitlab的ci-runner中，gitlab的ci-runner已经以docker容器（名为“gitlab-runner”）的方式事先架设好了，直接用命令注册：

```
docker exec -it gitlab-runner gitlab-runner register \
  --non-interactive \
  --executor "docker" \
  --docker-image sk-rasbian \
  --description "skteam rasbian" \
  --url "http://192.168.99.xx" \
  --registration-token "xxxxxxxxxxxxxxxxx" \
  --tag-list "rasbian" \
  --run-untagged \
  --locked="false" \
  --docker-extra-hosts "skgit:192.168.99.xx" \
  --docker-pull-policy "if-not-present"
```

写个C的helloword，再建个仓库做CI测试，`.gitlab-ci`：

```
build:
  stage: build
  tags:
    - rasbian
  script:
    - gcc helloworld.c -o helloworld
    - readelf helloworld -h
  artifacts:
    paths:
      - helloworld
```

push后CI运行成功，生成了ARM机器的ELF：

![ci-test](_assets/%E6%90%AD%E5%BB%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83/ci-test.png)